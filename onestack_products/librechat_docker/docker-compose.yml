version: "3.4"

# Do not edit this file directly. Use a ‘docker-compose.override.yaml’ file if you can.
# Refer to `docker-compose.override.yaml.example’ for some sample configurations.

services:
    api:
        container_name: LibreChat
        # ports:
        #   - "${PORT}:${PORT}"
        depends_on:
            # - mongodb
            - rag_api
        image: ghcr.io/danny-avila/librechat-dev:latest
        restart: always
        user: "${UID}:${GID}"
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            - HOST=0.0.0.0
            - MONGO_URI=${MONGO_URI:-mongodb://mongodb:27017/LibreChat}
            - MEILI_HOST=${MEILI_HOST:-http://meilisearch:7700}
            - RAG_PORT=${RAG_PORT:-8000}
            - RAG_API_URL=http://rag_api:${RAG_PORT:-8000}
        volumes:
            - type: bind
              source: ./.env
              target: /app/.env
            - ./images:/app/client/public/images
            - ./logs:/app/api/logs
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.librechat.rule=Host(`chat.${TOP_LEVEL_DOMAIN}`)"
            - "traefik.http.routers.librechat.entrypoints=websecure"
            - "traefik.http.routers.librechat.tls.certresolver=${CERT_RESOLVER:-letsencrypt}"
            - "traefik.http.services.librechat.loadbalancer.server.port=3080"
        networks:
            - traefik_default
    meilisearch:
        container_name: chat-meilisearch
        image: getmeili/meilisearch:v1.7.3
        restart: always
        user: "${UID}:${GID}"
        environment:
            - MEILI_HOST=http://meilisearch:7700
            - MEILI_NO_ANALYTICS=true
        volumes:
            - ./meili_data_v1.7:/meili_data
        networks:
            - traefik_default
    vectordb:
        container_name: vectordb
        image: ankane/pgvector:latest
        environment:
            POSTGRES_DB: mydatabase
            POSTGRES_USER: myuser
            POSTGRES_PASSWORD: mypassword
        restart: always
        volumes:
            - pgdata2:/var/lib/postgresql/data
        networks:
            - traefik_default

    rag_api:
        container_name: rag_api
        image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:latest
        environment:
            - DB_HOST=vectordb
            - RAG_PORT=${RAG_PORT:-8000}
        restart: always
        depends_on:
            - vectordb
        env_file:
            - .env
        networks:
            - traefik_default

volumes:
    pgdata2:

networks:
    librechat:
    traefik_default:
        external: true
